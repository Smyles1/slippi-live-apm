{"version":3,"file":"SlippiGame.esm.js","sources":["../src/SlippiGame.ts"],"sourcesContent":["import type { StatOptions, StatsType } from \"./stats\";\nimport {\n  ActionsComputer,\n  ComboComputer,\n  ConversionComputer,\n  generateOverallStats,\n  InputComputer,\n  Stats,\n  StockComputer,\n} from \"./stats\";\nimport type {\n  EventCallbackFunc,\n  FrameEntryType,\n  FramesType,\n  GameEndType,\n  GameStartType,\n  GeckoListType,\n  MetadataType,\n  PlacementType,\n  RollbackFrames,\n} from \"./types\";\nimport { SlpParser, SlpParserEvent } from \"./utils/slpParser\";\nimport type { SlpReadInput } from \"./utils/slpReader\";\nimport { closeSlpFile, getMetadata, iterateEvents, openSlpFile, SlpInputSource } from \"./utils/slpReader\";\n\n/**\n * Slippi Game class that wraps a file\n */\nexport class SlippiGame {\n  private input: SlpReadInput;\n  private metadata: MetadataType | null = null;\n  private finalStats: StatsType | null = null;\n  private parser: SlpParser;\n  private readPosition: number | null = null;\n  private actionsComputer: ActionsComputer = new ActionsComputer();\n  private conversionComputer: ConversionComputer = new ConversionComputer();\n  private comboComputer: ComboComputer = new ComboComputer();\n  private stockComputer: StockComputer = new StockComputer();\n  private inputComputer: InputComputer = new InputComputer();\n  protected statsComputer: Stats;\n\n  public constructor(input: string | Buffer | ArrayBuffer, opts?: StatOptions) {\n    if (typeof input === \"string\") {\n      this.input = {\n        source: SlpInputSource.FILE,\n        filePath: input,\n      };\n    } else if (input instanceof Buffer) {\n      this.input = {\n        source: SlpInputSource.BUFFER,\n        buffer: input,\n      };\n    } else if (input instanceof ArrayBuffer) {\n      this.input = {\n        source: SlpInputSource.BUFFER,\n        buffer: Buffer.from(input),\n      };\n    } else {\n      throw new Error(\"Cannot create SlippiGame with input of that type\");\n    }\n\n    // Set up stats calculation\n    this.statsComputer = new Stats(opts);\n    this.statsComputer.register(\n      this.actionsComputer,\n      this.comboComputer,\n      this.conversionComputer,\n      this.inputComputer,\n      this.stockComputer,\n    );\n    this.parser = new SlpParser();\n    this.parser.on(SlpParserEvent.SETTINGS, (settings) => {\n      this.statsComputer.setup(settings);\n    });\n    // Use finalized frames for stats computation\n    this.parser.on(SlpParserEvent.FINALIZED_FRAME, (frame: FrameEntryType) => {\n      this.statsComputer.addFrame(frame);\n    });\n  }\n\n  private _process(shouldStop: EventCallbackFunc = () => false): void {\n    if (this.parser.getGameEnd() !== null) {\n      return;\n    }\n    const slpfile = openSlpFile(this.input);\n    // Generate settings from iterating through file\n    this.readPosition = iterateEvents(\n      slpfile,\n      (command, payload) => {\n        if (!payload) {\n          // If payload is falsy, keep iterating. The parser probably just doesn't know\n          // about this command yet\n          return false;\n        }\n        this.parser.handleCommand(command, payload);\n        return shouldStop(command, payload);\n      },\n      this.readPosition,\n    );\n    closeSlpFile(slpfile);\n  }\n\n  /**\n   * Gets the game settings, these are the settings that describe the starting state of\n   * the game such as characters, stage, etc.\n   */\n  public getSettings(): GameStartType | null {\n    // Settings is only complete after post-frame update\n    this._process(() => this.parser.getSettings() !== null);\n    return this.parser.getSettings();\n  }\n\n  public getLatestFrame(): FrameEntryType | null {\n    this._process();\n    return this.parser.getLatestFrame();\n  }\n\n  public getGameEnd(): GameEndType | null {\n    this._process();\n    return this.parser.getGameEnd();\n  }\n\n  public getFrames(): FramesType {\n    this._process();\n    return this.parser.getFrames();\n  }\n\n  public getRollbackFrames(): RollbackFrames {\n    this._process();\n    return this.parser.getRollbackFrames();\n  }\n\n  public getGeckoList(): GeckoListType | null {\n    this._process(() => this.parser.getGeckoList() !== null);\n    return this.parser.getGeckoList();\n  }\n\n  public getStats(): StatsType | null {\n    if (this.finalStats) {\n      return this.finalStats;\n    }\n\n    this._process();\n\n    const settings = this.parser.getSettings();\n    if (settings === null) {\n      return null;\n    }\n\n    // Finish processing if we're not up to date\n    this.statsComputer.process();\n    const inputs = this.inputComputer.fetch();\n    const stocks = this.stockComputer.fetch();\n    const conversions = this.conversionComputer.fetch();\n    const playableFrameCount = this.parser.getPlayableFrameCount();\n    const overall = generateOverallStats({ settings, inputs, conversions, playableFrameCount });\n\n    const gameEnd = this.parser.getGameEnd();\n    const gameComplete = gameEnd !== null;\n\n    const stats: StatsType = {\n      lastFrame: this.parser.getLatestFrameNumber(),\n      playableFrameCount,\n      stocks: stocks,\n      conversions: conversions,\n      combos: this.comboComputer.fetch(),\n      actionCounts: this.actionsComputer.fetch(),\n      overall: overall,\n      gameComplete,\n    };\n\n    if (gameComplete) {\n      // If the game is complete, store a cached version of stats because it should not\n      // change anymore. Ideally the statsCompuer.process and fetch functions would simply do no\n      // work in this case instead but currently the conversions fetch function,\n      // generateOverallStats, and maybe more are doing work on every call.\n      this.finalStats = stats;\n    }\n\n    return stats;\n  }\n\n  public getMetadata(): MetadataType | null {\n    if (this.metadata) {\n      return this.metadata;\n    }\n    const slpfile = openSlpFile(this.input);\n    this.metadata = getMetadata(slpfile);\n    closeSlpFile(slpfile);\n    return this.metadata;\n  }\n\n  public getFilePath(): string | null {\n    if (this.input.source !== SlpInputSource.FILE) {\n      return null;\n    }\n\n    return this.input.filePath ?? null;\n  }\n\n  public getWinners(): PlacementType[] {\n    this._process();\n\n    const gameEnd = this.getGameEnd();\n    if (!gameEnd) {\n      return [];\n    }\n\n    const placements = gameEnd.placements;\n    const firstPosition = placements.find((placement) => placement?.position === 0);\n    if (!firstPosition) {\n      return [];\n    }\n\n    const settings = this.getSettings();\n    if (settings?.isTeams) {\n      const winningTeam = settings.players.find(({ playerIndex }) => playerIndex === firstPosition.playerIndex)?.teamId;\n      return placements.filter((placement) => {\n        const teamId = settings.players.find(({ playerIndex }) => playerIndex === placement.playerIndex)?.teamId;\n        return teamId === winningTeam;\n      });\n    }\n\n    return [firstPosition];\n  }\n}\n"],"names":["SlippiGame","constructor","input","opts","metadata","finalStats","parser","readPosition","actionsComputer","ActionsComputer","conversionComputer","ConversionComputer","comboComputer","ComboComputer","stockComputer","StockComputer","inputComputer","InputComputer","statsComputer","source","SlpInputSource","FILE","filePath","Buffer","BUFFER","buffer","ArrayBuffer","from","Error","Stats","register","SlpParser","on","SlpParserEvent","SETTINGS","settings","setup","FINALIZED_FRAME","frame","addFrame","_process","shouldStop","getGameEnd","slpfile","openSlpFile","iterateEvents","command","payload","handleCommand","closeSlpFile","getSettings","getLatestFrame","getFrames","getRollbackFrames","getGeckoList","getStats","process","inputs","fetch","stocks","conversions","playableFrameCount","getPlayableFrameCount","overall","generateOverallStats","gameEnd","gameComplete","stats","lastFrame","getLatestFrameNumber","combos","actionCounts","getMetadata","getFilePath","getWinners","placements","firstPosition","find","placement","position","isTeams","winningTeam","players","playerIndex","teamId","filter"],"mappings":"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"}